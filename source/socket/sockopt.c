/**************************************************************************************
 *  Copyright (c) Artificial Intelligence Infinity.
 *  Filename: sockopt.c 
 *  Description: this file contains apis of sockopt
 *  Author: caoyun
 *  Create:2010-01-25
 *  Modification history:
 *  2010-01-25, created the file,           caoyun
 *  2010-03-09, refreshed the file,         chenwangxian
 *
 *
 **************************************************************************************/ 
#include "foundationSocket.h"
#include "foundationDbg.h"

/*========================================================
 *			基本 sockopt API  Wrapper 
 * =====================================================*/
/*************************************************
* Function:       Getsockopt()
* Description:    getsockopt()的封装函数 
* Input:		  sockfd---套接口描述字
*                 level---套接口属性级别
*                 optname---套接口属性选项名
* Output:         optval---套接口属性选项值
*                 optlen---套接口属性选项长度
* Return:         0---success/-1---fail
*************************************************/
int Getsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen)
{
	int rval;

	if((rval = getsockopt(sockfd, level, optname, optval, optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "getsockopt failed!\n");	
	}
	
	return rval;
}

/*************************************************
* Function:       Setsockopt()
* Description:    setsockopt()的封装函数 
* Input:		  sockfd---套接口描述字
*                 level---套接口属性级别
*                 optname---套接口属性选项名
*                 optval---套接口属性选项值
*                 optlen---套接口属性选项长度
* Output:         N/A 
* Return:         0---success/-1---fail
*************************************************/
int Setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen)
{
	int rval;

	if((rval = setsockopt(sockfd, level, optname, optval, optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "setsockopt failed!\n");	
	}
	
	return rval;
}


/*===========================================================
 *			高级 sockopt API Wrapper
 * ========================================================*/
/*************************************************
* Function:		  GetsockRecvBuf()
* Description:    获取套接口接收缓冲区长度 
* Input:		  sockfd---套接口描述字 
* Output:         bufsize---套件口缓冲区长度 
* Return:         0---success/-1---fail
*************************************************/
int GetsockRecvBuf(int sockfd, int *bufsize)
{
	int rval;
	int optlen = sizeof(int);

	if(bufsize==NULL)
	{
		return -1;	
	}

	if((rval = Getsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, bufsize,(socklen_t*)&optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "Getsockopt_recvbuf failed!\n");		
	}

	if(optlen != sizeof(int))
	{
		debug_info(DEBUG_LEVEL_4, "Getsockopt_recvbuf optlen error!\n");		
	}

	return rval;
}

/*************************************************
* Function:		  SetsockRecvBuf()
* Description:    设置套接口接收缓冲区长度 
* Input:		  sockfd---套接口描述字 
*                 bufsize---套件口缓冲区长度
* Output:         N/A 
* Return:         0---success/-1---fail
*************************************************/
int SetsockRecvBuf(int sockfd, int bufsize)
{
	int rval;
	socklen_t optlen = sizeof(int);

	if((rval = Setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, (char*)&bufsize, optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "Setsockopt_recvbuf failed!\n");		
	}

	return rval;
}

/*************************************************
* Function:		  GetsockSendBuf()
* Description:    获取套接口发送缓冲区长度 
* Input:		  sockfd---套接口描述字 
* Output:         bufsize---套件口缓冲区长度 
* Return:         0---success/-1---fail
*************************************************/
int GetsockSendBuf(int sockfd, int *bufsize)
{
	int rval;
	socklen_t optlen = sizeof(int);

	if(bufsize==NULL)
	{
		return -1;	
	}

	if((rval = Getsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, bufsize,(socklen_t*)&optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "Getsockopt_sendbuf failed!\n");		
	}

	if(optlen != sizeof(int))
	{
		debug_info(DEBUG_LEVEL_4, "Getsockopt_sendbuf optlen error!\n");		
	}

	return rval;
}

/*************************************************
* Function:		  SetsockSendBuf()
* Description:    设置套接口发送缓冲区长度 
* Input:		  sockfd---套接口描述字 
*                 bufsize---套件口缓冲区长度
* Output:         N/A  
* Return:         0---success/-1---fail
*************************************************/
int SetsockSendBuf(int sockfd, int bufsize)
{
	int rval;
	socklen_t optlen = sizeof(int);

	if((rval = Setsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, (char*)&bufsize, optlen)) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "Setsockopt_sendbuf failed!\n");		
	}

	return rval;
}

/*************************************************
* Function:       SetsockLingerOn()
* Description:    设置套接口强制关闭连接属性 
* Input:		  sockfd---套接口描述字 
* Output:         N/A
* Return:         0---success/-1---fail
*************************************************/
int SetsockLingerOn(int sockfd)
{
	struct linger clinger;
	int rval;

	clinger.l_onoff = 1;		//强制关闭sockt属性
	clinger.l_linger = 0;		//没有延迟
	if((rval = Setsockopt(sockfd, SOL_SOCKET, SO_LINGER, (char *)&clinger, sizeof(clinger))) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "Setsockopt_lingerOn failed!\n");		
	}

	return rval;
}

/*************************************************
* Function:       SetsockReuse()
* Description:    设置套接口允许重用本地地址属性 
* Input:		  sockfd---套接口描述字 
* Output:         N/A
* Return:         0---success/-1---fail
*************************************************/
int SetsockReuse(int sockfd)
{
	int optval;
	int rval;

    optval = 1;
	if((rval = Setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, (char *)&optval, sizeof(optval))) == -1)
	{
		debug_info(DEBUG_LEVEL_4, "SetsockReuse failed!\n");		
	}

	return rval;
}

